name: Multi-Stage Salesforce Deployment with Rollback

on:
  push:
    branches:
      - qa
      - uat
      - preprod

env:
  API_VERSION: '60.0'

jobs:
  deploy:
    runs-on: ubuntu-latest
    container:
      image: salesforce/cli:latest-full

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” Authenticate to Salesforce Org
        run: |
          if [[ "${GITHUB_REF##*/}" == "qa" ]]; then
            echo "${{ secrets.SFDX_AUTH_URL_QA }}" > auth-url.txt
          elif [[ "${GITHUB_REF##*/}" == "uat" ]]; then
            echo "${{ secrets.SFDX_AUTH_URL_UAT }}" > auth-url.txt
          elif [[ "${GITHUB_REF##*/}" == "preprod" ]]; then
            echo "${{ secrets.SFDX_AUTH_URL_PREPROD }}" > auth-url.txt
          fi
          sf org login sfdx-url --sfdx-url-file auth-url.txt --alias target-org --set-default

      - name: ğŸ” Generate Delta Package
        run: bash scripts/generate-delta.sh

      - name: ğŸ›‘ Abort if Delta is Empty
        run: |
          if [[ -z "$(find delta/package -type f -not -name package.xml)" ]]; then
            echo "âš ï¸ No metadata changes detected. Skipping deployment."
            exit 0
          fi

      - name: ğŸ“¦ Backup Delta from Org
        run: bash scripts/backup-delta.sh

      - name: âœ… Validate Deployment
        run: |
          if [[ -d delta/package && -f delta/package/package.xml ]]; then
            sf project deploy preview \
              --source-dir delta/package \
              --manifest delta/package/package.xml \
              --target-org target-org
          else
            echo "âŒ Delta folder or package.xml not found. Skipping validation."
            exit 1
          fi

      - name: ğŸš€ Deploy Delta
        if: success()
        run: bash scripts/deploy-delta.sh

      - name: ğŸ§¹ Final Cleanup of Delta Folder
        if: success()
        run: |
          echo "ğŸ§¹ Removing delta folder..."
          rm -rf delta
          echo "âœ… Delta folder cleaned up."
