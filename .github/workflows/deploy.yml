name: Multi-Stage Salesforce Deployment with Rollback

on:
  push:
    branches:
      - QA_Branch
      - UAT_Branch
      - PreProd_Branch

env:
  API_VERSION: '60.0'

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    container:
      image: vlenergy/salesforcevlocity:v4.0

    steps:
      - name: ⬇️ Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: 🧾 Print Branch Name
        
        run: |
          echo "Branch: ${GITHUB_REF##*/}"

      - name: 🔧 Make Scripts Executable
        run: chmod +x scripts/*.sh

      - name: 🔐 Authenticate to Salesforce Org
        run: |
          if [[ "${GITHUB_REF##*/}" == "QA_Branch" ]]; then
            echo "${{ secrets.SFDX_AUTH_URL_QA }}" > auth-url.txt
          elif [[ "${GITHUB_REF##*/}" == "UAT_Branch" ]]; then
            echo "${{ secrets.SFDX_AUTH_URL_UAT }}" > auth-url.txt
          elif [[ "${GITHUB_REF##*/}" == "PreProd_Branch" ]]; then
            echo "${{ secrets.SFDX_AUTH_URL_PREPROD }}" > auth-url.txt
          else
            echo "❌ Unknown branch. Cannot determine target org."
            exit 1
          fi

          sf org login sfdx-url --sfdx-url-file auth-url.txt --alias target-org --set-default

      - name: 🔍 Generate Delta Package
        run: |
            cd $GITHUB_WORKSPACE
            bash scripts/generate-delta.sh

      - name: 🛑 Abort if Delta is Empty
        run: |
          if [[ -z "$(find delta/package -type f -not -name package.xml)" ]]; then
            echo "⚠️ No metadata changes detected. Skipping deployment."
            exit 0
          fi

      - name: 📦 Backup Delta from Org
        run: bash scripts/backup-delta.sh

      - name: ✅ Validate Deployment
        run: |
          echo "🔎 Validating deployment..."
          sf project deploy preview \
            --source-dir delta/package \
            --manifest delta/package/package.xml \
            --target-org target-org || { echo "❌ Validation failed. Fix your code and try again."; exit 1; }

      - name: 🚀 Deploy Delta to Org
        run: |
          echo "🚀 Deploying delta to org..."
          sf project deploy start \
            --source-dir delta/package \
            --manifest delta/package/package.xml \
            --target-org target-org \
            --wait 10 \
            --verbose || { echo "❌ Deployment failed."; exit 1; }

      - name: 🧹 Final Cleanup of Delta Folder
        if: success()
        run: |
          echo "🧹 Removing delta folder..."
          rm -rf delta
          echo "✅ Delta folder cleaned up."
